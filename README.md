# React で入力フォームをリストとして表示する場合のレンダリングのパフォーマンス向上方法

## 問題点

- 入力フォームの値を配列として State で管理して入力フォームの値が変更された時のハンドラーを共通化した場合、ハンドラーは配列に依存するため Object.is()での比較が常に false になり入力のたびに再計算される
- ハンドラーが再計算されるとハンドラーに依存する共通のリスト要素のコンポーネントが再レンダリングされてしまう
- 値の変更がなかったフォームも 1 文字入力するたびに再レンダリングされてしまうため入力が遅くなるなどパフォーマンスに悪影響を及ぼす
- 単純にハンドラーの変更を無視するように変更すると他のフォームのハンドラーが参照する State は古い状態のものなので他のフォームで入力時に古い State をもとに値が更新されて再レンダリングされてしまう

## 解決策

- ~~入力フォームのフォーカス状態を別途 State として管理する~~
- ~~共通のリスト要素のコンポーネントをメモ化してハンドラーの変更があった場合に再レンダリングされないように React.memo の第二引数の比較処理をカスタマイズしてハンドラーの判定を除外する~~
- ~~フォーカス状態に変更があった場合は共通のリスト要素のコンポーネントを再レンダリングすることでハンドラーから最新の State を参照できるようにする~~

### useState で前の State を元に次の State を計算するようにした(2021/9/19 修正)

- カスタムフック内に定義した汎用ハンドラー内で更新する値を計算してから useState の戻り値の set 関数を呼び出すのではなく useState の set 関数で前の State を元に次の State を更新するようにしたことで常に最新の State が参照できる
- 汎用ハンドラーが直接 useState の戻り値の State を参照しなくなり deps には常に同一性が保たれる set 関数を指定することで汎用ハンドラーは再計算されなくなった
- メモ化したコンポーネントで汎用ハンドラーの比較をしても汎用ハンドラーは同一なため不要なレンダリングがされない

## 参考

- useState の関数型の更新
  - React, 「関数型の更新」, 2021-09-19, https://ja.reactjs.org/docs/hooks-reference.html#functional-updates , (2021-09-19 閲覧)
